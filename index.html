<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vocab Trainer — Меню и уроки</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --panel: #111827; /* gray-900 */
      --muted: #94a3b8; /* slate-400 */
      --text: #e5e7eb; /* gray-200 */
      --accent: #22d3ee; /* cyan-400 */
      --accent-2: #38bdf8; /* sky-400 */
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: linear-gradient(180deg, var(--bg), #0b1224);
      color: var(--text); font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", "Noto Sans", Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .container { max-width: 960px; margin: 0 auto; padding: 24px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom: 18px; }
    h1 { font-size: 22px; margin: 0; letter-spacing: .2px; }
    .muted { color: var(--muted); }
    .card {
      background: rgba(17,24,39,.8);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px; padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 14px; }
    .lesson {
      padding: 14px 16px; border-radius: 14px; background: #0b1224; border: 1px solid rgba(255,255,255,.06);
      cursor: pointer; transition: transform .12s ease, border-color .12s ease;
    }
    .lesson:hover { transform: translateY(-2px); border-color: rgba(56,189,248,.55); }
    .lesson h3 { margin: 0 0 6px; font-size: 16px; color: #e2e8f0; }
    .lesson small { color: var(--muted); }

    .toolbar { display:flex; flex-wrap:wrap; align-items:center; gap: 8px; margin: 10px 0 14px; }
    .btn, button { cursor:pointer; padding:10px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08);
      background:#0b1224; color: var(--text); transition: background .12s ease, transform .08s ease; }
    .btn:hover { background:#0d1530; }
    .btn:active { transform: translateY(1px); }

    .btn-xl { padding: 16px 18px; font-size: 16px; border-radius: 14px; }

    .pill { padding:6px 10px; font-size: 12px; border-radius: 999px; background: rgba(34,211,238,.12); color: var(--accent);
      border:1px solid rgba(34,211,238,.35); }

    .viewer { display:flex; flex-direction:column; gap:12px; }
    .card-big { text-align:center; padding: 28px; border-radius: 18px; background:#0b1224; border: 1px solid rgba(255,255,255,.06); }
    .word-en { font-size: 28px; font-weight: 700; letter-spacing:.3px; }
    .word-ru { font-size: 20px; color:#cbd5e1; margin-top:8px; }
    .counter { color: var(--muted); font-size: 14px; }
    .nav { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .nav .btn { flex:1; }

    .row { display:flex; align-items:center; gap:10px; }
    .hide { display:none; }
    .right { text-align:right; }
    a.link { color: var(--accent-2); text-decoration: none; }
    a.link:hover { text-decoration: underline; }

    .menu { display:grid; gap: 12px; }

    @media (max-width: 480px) {
      .word-en { font-size: 22px; }
      .word-ru { font-size: 18px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Vocab Trainer <span class="muted">· меню</span></h1>
      <div id="hdr-actions" class="row">
        <button id="btn-menu" class="btn hide">В меню</button>
        <button id="btn-home" class="btn hide">К урокам</button>
      </div>
    </header>

    <!-- Главное меню (как было, плюс пункт Выбор уроков) -->
    <div id="screen-menu" class="card">
      <div class="toolbar">
        <span class="pill">Главное меню</span>
        <span style="margin-left:auto" class="muted"><a class="link" href="./words.json" target="_blank" rel="noopener">Открыть words.json</a></span>
      </div>
      <div class="menu">
        <button id="menu-play-all" class="btn btn-xl">Учить все слова</button>
        <button id="menu-choose-lesson" class="btn btn-xl">Выбор уроков</button>
        <button id="menu-about" class="btn">О приложении</button>
      </div>
    </div>

    <!-- Выбор уроков -->
    <div id="screen-lessons" class="card hide">
      <div class="toolbar">
        <span class="pill">Выберите урок</span>
        <span id="lessons-meta" class="muted"></span>
      </div>
      <div id="lessons" class="grid" aria-live="polite"></div>
    </div>

    <!-- Просмотр слов -->
    <div id="screen-viewer" class="card hide">
      <div class="toolbar">
        <span id="lesson-title" class="pill"></span>
        <span id="badge-count" class="muted"></span>
        <span style="margin-left:auto" class="muted">Стрелки ◀ ▶, Enter — следующая</span>
      </div>

      <div class="viewer">
        <div class="card-big">
          <div id="word-en" class="word-en">—</div>
          <div id="word-ru" class="word-ru">—</div>
          <div id="counter" class="counter">0 / 0</div>
        </div>
        <div class="nav">
          <button id="prev" class="btn">◀ Назад</button>
          <button id="shuffle" class="btn">Перемешать</button>
          <button id="next" class="btn">Вперёд ▶</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  const WORDS_URL = './words.json';

  // ===== Helpers =====
  function $(id) { return document.getElementById(id); }
  function show(el, v=true){ el.classList.toggle('hide', !v); }

  async function fetchJsonNoCache(urlStr) {
    const url = new URL(urlStr, location.href);
    url.searchParams.set('v', Date.now()); // cache-buster
    const res = await fetch(url.toString(), { cache: 'no-store' });
    if (!res.ok) throw new Error(urlStr + ' HTTP ' + res.status);
    let text = await res.text();
    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1); // strip BOM
    const t = text.trim();
    if (!(t.startsWith('{') || t.startsWith('['))) {
      throw new Error('Получено не JSON (возможно HTML/404)');
    }
    return JSON.parse(text);
  }

  async function loadLessons() {
    const data = await fetchJsonNoCache(WORDS_URL);
    if (!data || !Array.isArray(data.lessons)) {
      throw new Error('Неверная структура words.json: нужен { lessons: [...] }');
    }
    // Validate each lesson shape
    data.lessons.forEach((l,i) => {
      if (!Array.isArray(l.words)) throw new Error('lesson['+i+']: отсутствует массив words');
    });
    return data.lessons;
  }

  // ===== Rendering state =====
  const state = {
    lessons: [],
    currentLesson: null,
    idx: 0,
    order: [], // indices order
  };

  // ===== Screens nav =====
  function gotoMenu(){
    show($('screen-menu'), true);
    show($('screen-lessons'), false);
    show($('screen-viewer'), false);
    show($('btn-menu'), false);
    show($('btn-home'), false);
    document.querySelector('h1 .muted').textContent = '· меню';
  }
  function gotoLessons(){
    show($('screen-menu'), false);
    show($('screen-lessons'), true);
    show($('screen-viewer'), false);
    show($('btn-menu'), true);
    show($('btn-home'), false);
    document.querySelector('h1 .muted').textContent = '· уроки';
  }
  function gotoViewer(){
    show($('screen-menu'), false);
    show($('screen-lessons'), false);
    show($('screen-viewer'), true);
    show($('btn-menu'), true);
    show($('btn-home'), true);
    document.querySelector('h1 .muted').textContent = '· карточки';
  }

  function renderLessons() {
    const wrap = $('lessons');
    wrap.innerHTML = '';
    $('lessons-meta').textContent = `Всего уроков: ${state.lessons.length}`;

    state.lessons.forEach(lesson => {
      const div = document.createElement('div');
      div.className = 'lesson';
      const count = Array.isArray(lesson.words) ? lesson.words.length : 0;
      div.innerHTML = `<h3>${escapeHtml(lesson.title || 'Без названия')}</h3>
        <small>${count} слов</small>`;
      div.onclick = () => openLesson(lesson);
      wrap.appendChild(div);
    });
  }

  function openLesson(lesson) {
    state.currentLesson = lesson;
    state.idx = 0;
    state.order = [...Array(lesson.words.length).keys()];
    $('lesson-title').textContent = lesson.title;
    $('badge-count').textContent = `${lesson.words.length} слов`;

    gotoViewer();
    renderCard();
  }

  function playAll(){
    // Сборка всех слов в один псевдо-урок
    const words = [];
    state.lessons.forEach(L => {
      (L.words||[]).forEach(pair => words.push(pair));
    });
    openLesson({ id: 'all', title: 'Все слова', words });
  }

  function backToLessons(){
    state.currentLesson = null;
    gotoLessons();
  }

  function renderCard(){
    const L = state.currentLesson;
    if (!L || !L.words || L.words.length === 0) {
      $('word-en').textContent = 'Нет слов';
      $('word-ru').textContent = '—';
      $('counter').textContent = '0 / 0';
      return;
    }
    const i = clamp(state.idx, 0, L.words.length - 1);
    state.idx = i;
    const idxInLesson = state.order[i];
    const pair = L.words[idxInLesson];
    const [en, ru] = Array.isArray(pair) ? pair : ['—','—'];
    $('word-en').textContent = en;
    $('word-ru').textContent = ru;
    $('counter').textContent = `${i+1} / ${L.words.length}`;
  }

  function next(){
    const L = state.currentLesson; if (!L) return;
    state.idx = (state.idx + 1) % L.words.length;
    renderCard();
  }
  function prev(){
    const L = state.currentLesson; if (!L) return;
    state.idx = (state.idx - 1 + L.words.length) % L.words.length;
    renderCard();
  }
  function shuffle(){
    const L = state.currentLesson; if (!L) return;
    // Fisher–Yates
    const arr = state.order;
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    state.idx = 0;
    renderCard();
  }

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'
    })[c]);
  }

  // ===== Events =====
  $('btn-menu').addEventListener('click', gotoMenu);
  $('btn-home').addEventListener('click', backToLessons);

  $('next').addEventListener('click', next);
  $('prev').addEventListener('click', prev);
  $('shuffle').addEventListener('click', shuffle);

  $('menu-choose-lesson').addEventListener('click', gotoLessons);
  $('menu-play-all').addEventListener('click', playAll);
  $('menu-about').addEventListener('click', () => alert(`Vocab Trainer PWA\nВыберите урок или учите все слова подряд.`));

  window.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight' || e.key === 'Enter') next();
    else if (e.key === 'ArrowLeft') prev();
  });

  // ===== Boot =====
  (async () => {
    try {
      state.lessons = await loadLessons();
      renderLessons();
      gotoMenu();
      runSelfTests(); // <-- простые тесты после загрузки
    } catch (e) {
      console.error('Не удалось загрузить уроки:', e);
      $('lessons').innerHTML = '<div class="muted">words.json недоступен или имеет неверную структуру.</div>';
      gotoMenu();
      runSelfTests(true);
    }
  })();

  // ===== Простейшие self-tests ("тест-кейсы") =====
  function runSelfTests(errorMode=false){
    const results = [];
    const assert = (name, cond) => { results.push({ name, cond }); };

    // UI элементы
    assert('#screen-menu существует', !!document.getElementById('screen-menu'));
    assert('#screen-lessons существует', !!document.getElementById('screen-lessons'));
    assert('#screen-viewer существует', !!document.getElementById('screen-viewer'));

    // Данные
    assert('state.lessons — массив', Array.isArray(state.lessons));
    if (Array.isArray(state.lessons) && state.lessons.length > 0) {
      const L0 = state.lessons[0];
      assert('lesson[0].words — массив', Array.isArray(L0.words));
      if (Array.isArray(L0.words) && L0.words.length > 0) {
        const p = L0.words[0];
        assert('word pair — массив из 2 элементов', Array.isArray(p) && p.length === 2);
      }
    }

    // Навигация функций
    assert('Функция openLesson доступна', typeof openLesson === 'function');
    assert('Функция renderLessons доступна', typeof renderLessons === 'function');

    // Результаты
    const ok = results.filter(r=>r.cond).length;
    const fail = results.length - ok;
    console.group('%cSelf-tests', 'color:#22d3ee');
    results.forEach(r => console.log(r.cond ? '✅' : '❌', r.name));
    console.log(`Итог: ${ok}/${results.length} пройдено${fail?`, ${fail} ошибок`:''}.`, errorMode?'(errorMode)':'');
    console.groupEnd();
  }

  // ===== SW (не обязателен, но корректная регистрация с относительным путём) =====
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(console.warn);
  }
  </script>
</body>
</html>
