<!doctype html>

<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vocab Trainer — Меню и уроки</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --panel: #111827; /* gray-900 */
      --muted: #94a3b8; /* slate-400 */
      --text: #e5e7eb; /* gray-200 */
      --accent: #22d3ee; /* cyan-400 */
      --accent-2: #38bdf8; /* sky-400 */
      --danger: #fb7185; /* rose-400 */
      --success: #34d399; /* green-400 */
    }
    html, body { height: 100%; }
    body {
      margin: 0; background: linear-gradient(180deg, var(--bg), #0b1224);
      color: var(--text); font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", "Noto Sans", Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .container { max-width: 960px; margin: 0 auto; padding: 24px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom: 18px; }
    h1 { font-size: 22px; margin: 0; letter-spacing: .2px; }
    .muted { color: var(--muted); }
    .card {
      background: rgba(17,24,39,.8);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px; padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 14px; }
    .lesson {
      padding: 14px 16px; border-radius: 14px; background: #0b1224; border: 1px solid rgba(255,255,255,.06);
      cursor: pointer; transition: transform .12s ease, border-color .12s ease;
    }
    .lesson:hover { transform: translateY(-2px); border-color: rgba(56,189,248,.55); }
    .lesson h3 { margin: 0 0 6px; font-size: 16px; color: #e2e8f0; }
    .lesson small { color: var(--muted); }.toolbar { display:flex; flex-wrap:wrap; align-items:center; gap: 8px; margin: 10px 0 14px; }
.btn, button { cursor:pointer; padding:10px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08);
  background:#0b1224; color: var(--text); transition: background .12s ease, transform .08s ease; }
.btn:hover { background:#0d1530; }
.btn:active { transform: translateY(1px); }

.btn-xl { padding: 16px 18px; font-size: 16px; border-radius: 14px; }

.pill { padding:6px 10px; font-size: 12px; border-radius: 999px; background: rgba(34,211,238,.12); color: var(--accent);
  border:1px solid rgba(34,211,238,.35); }
.pill-hard { background: rgba(251,113,133,.15); color: var(--danger); border-color: rgba(251,113,133,.45); }
.pill-dir { background: rgba(56,189,248,.15); color: var(--accent-2); border-color: rgba(56,189,248,.45); }

.viewer { display:flex; flex-direction:column; gap:12px; }
.card-big { text-align:center; padding: 28px; border-radius: 18px; background:#0b1224; border: 1px solid rgba(255,255,255,.06); }
.word-en { font-size: 28px; font-weight: 700; letter-spacing:.3px; }
.word-ru { font-size: 20px; color:#cbd5e1; margin-top:8px; }
.counter { color: var(--muted); font-size: 14px; }
.nav { display:flex; flex-wrap:wrap; align-items:center; gap:10px; }
.nav .btn { flex:1; }

.row { display:flex; align-items:center; gap:10px; }
.hide { display:none; }
.right { text-align:right; }
a.link { color: var(--accent-2); text-decoration: none; }
a.link:hover { text-decoration: underline; }

.menu { display:grid; gap: 12px; }

@media (max-width: 480px) {
  .word-en { font-size: 22px; }
  .word-ru { font-size: 18px; }
}
.touch-hint { display:none; }
.kbd-hint { color: var(--muted); }

/* Мобильные улучшения */
@media (max-width: 640px) {
  .btn, button { padding:14px 16px; border-radius: 14px; font-size: 17px; }
  .btn-xl { padding: 18px 20px; font-size: 18px; }
  .viewer .nav { gap: 8px; }
  .card-big { padding: 32px 18px; }
  .word-en, #word-front { font-size: 26px; }
  .word-ru, #word-back { font-size: 20px; }
  /* скрываем подсказку про клавиатуру на мобильных */
  .kbd-hint { display:none; }
  .touch-hint { display:inline; color: var(--muted); }
  #badge-dir { cursor:pointer; user-select:none;}
  #badge-dir:hover {opacity: 0.8;}
}

  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Vocab Trainer <span class="muted">· меню</span></h1>
      <div id="hdr-actions" class="row">
        <button id="btn-menu" class="btn hide">В меню</button>
        <button id="btn-home" class="btn hide">К урокам</button>
      </div>
    </header><!-- Главное меню -->
<div id="screen-menu" class="card">
  <div class="toolbar">
    <span class="pill">Главное меню</span>
	<!--селектор книг-->
	<label for="book-select" class="muted" style="margin-left:12px;">Книга:</label>
    <select id="book-select" class="btn" style="padding:8px 10px; border-radius:10px; min-width:140px;">
      <option value="" disabled selected>Загрузка…</option>
    </select>

    <span style="margin-left:auto" class="muted">
      <a id="link-json" class="link" href="./words.json" target="_blank" rel="noopener">Открыть JSON</a>
    </span>
    <!--span style="margin-left:auto" class="muted"><a class="link" href="./words.json" target="_blank" rel="noopener">Открыть words.json</a></span-->
  </div>
  <div class="menu">
    <button id="menu-play-all" class="btn btn-xl">Учить все слова</button>	
    <button id="menu-play-hard" class="btn btn-xl">Учить HARD-слова</button>
    <button id="menu-about" class="btn">О приложении</button>
  </div>
</div>

<!-- Выбор уроков -->
<div id="screen-lessons" class="card hide">
  <div class="toolbar">
    <span class="pill">Выберите урок</span>
    <span id="lessons-meta" class="muted"></span>
  </div>
  <div id="lessons" class="grid" aria-live="polite"></div>
</div>

<!-- Просмотр слов -->
<div id="screen-viewer" class="card hide">
  <div class="toolbar" style="gap:12px; align-items:center;">
    <span id="lesson-title" class="pill"></span>
    <span id="badge-count" class="muted"></span>
    <span id="badge-hard" class="pill pill-hard hide">HARD</span>
    <span id="badge-dir" class="pill pill-dir" tabindex="0" role="button">EN→RU</span>
   </div>

  <div class="viewer">
    <div id="touch-area" class="card-big" style="touch-action:manipulation;">
      <div id="word-front" class="word-en">—</div>
      <div id="word-back" class="word-ru hide">—</div>
      <div id="counter" class="counter">0 / 0</div>
    </div>
    <div class="nav">
      <button id="prev" class="btn">◀ Назад</button>
      <button id="reveal" class="btn">Перевод</button>
      <button id="toggle-hard" class="btn">☆Повтор</button>
      <!--button id="toggle-dir" class="btn">EN↔RU</button-->
      <button id="shuffle" class="btn">Перемешать</button>
      <button id="next" class="btn">Вперёд ▶</button>
    </div>
  </div>
</div>

  </div>
  </div>  <script>
  const WORDS_URL = './words.json';
  const LS_HARD_KEY = 'vocabHardSetV1';

  // ===== Helpers =====
  function $(id) { return document.getElementById(id); }
  function show(el, v=true){ el.classList.toggle('hide', !v); }
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }

  async function fetchJsonNoCache(urlStr) {
    const url = new URL(urlStr, location.href);
    url.searchParams.set('v', Date.now()); // cache-buster
    const res = await fetch(url.toString(), { cache: 'no-store' });
    if (!res.ok) throw new Error(urlStr + ' HTTP ' + res.status);
    let text = await res.text();
    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1); // strip BOM
    const t = text.trim();
    if (!(t.startsWith('{') || t.startsWith('['))) {
      throw new Error('Получено не JSON (возможно HTML/404)');
    }
    return JSON.parse(text);
  }

  // Загрузка списка книг (id + title) из общего файла
  async function loadBooks() {
    const data = await fetchJsonNoCache(WORDS_URL);
    if (!data || !Array.isArray(data.books)) {
      throw new Error('Неверная структура words.json: нужен { books:[...] }');
    }
    return data.books.map(b => ({ id: String(b.id), title: b.title || ('Book ' + b.id) }));
  }
  
  // Загрузка уроков конкретной книги по id
  async function loadLessonsByBookId(bookId) {
    const data = await fetchJsonNoCache(WORDS_URL);
    if (!data || !Array.isArray(data.books)) {
      throw new Error('Неверная структура words.json: нужен { books:[...] }');
    }
    const book = data.books.find(b => String(b.id) === String(bookId));
    if (!book) throw new Error('Книга не найдена: ' + bookId);
  
    const lessons = (book.lessons || []).map((l, i) => ({
      id: l.id ?? `L${i+1}`,
      title: l.title || `Урок ${i+1}`,
      words: Array.isArray(l.words) ? l.words : []
    }));
  
    return { book, lessons };
  }
  
  // Заполнить селектор книг из массива [{id, title}]
  function populateBookSelect(books) {
    const sel = $('book-select');
    sel.innerHTML = books.map(b =>
      `<option value="${b.id}">${escapeHtml(b.title)}</option>`
    ).join('');
    // Выставляем текущее значение
    if (state.bookId) sel.value = String(state.bookId);
  }


  // ===== Hard store =====
  function loadHardSet(){
    try { return new Set(JSON.parse(localStorage.getItem(LS_HARD_KEY) || '[]')); }
    catch { return new Set(); }
  }
  function saveHardSet(set){ localStorage.setItem(LS_HARD_KEY, JSON.stringify([...set])); }
  const hardSet = loadHardSet();

  // ===== Rendering state =====
  const state = {
    lessons: [],
    currentLesson: null,
    idx: 0,
    order: [],
    revealed: false,
    dir: 'en-ru',
    bookId: '' // ← текущая книга
  };


  // ===== Screens nav =====
  function gotoMenu(){
    show($('screen-menu'), true);
    show($('screen-lessons'), false);
    show($('screen-viewer'), false);
    show($('btn-menu'), false);
    show($('btn-home'), false);
    document.querySelector('h1 .muted').textContent = '· меню';
    updateMenuHardButton();
  }
  function gotoLessons(){
    show($('screen-menu'), false);
    show($('screen-lessons'), true);
    show($('screen-viewer'), false);
    show($('btn-menu'), true);
    show($('btn-home'), false);
    document.querySelector('h1 .muted').textContent = '· уроки';
  }
  function gotoViewer(){
    show($('screen-menu'), false);
    show($('screen-lessons'), false);
    show($('screen-viewer'), true);
    show($('btn-menu'), true);
    show($('btn-home'), true);
    document.querySelector('h1 .muted').textContent = '· карточки';
  }

  // ===== Lessons rendering =====
  function renderLessons() {
    const wrap = $('lessons');
    wrap.innerHTML = '';
    $('lessons-meta').textContent = `Всего уроков: ${state.lessons.length}`;

    state.lessons.forEach(lesson => {
      const div = document.createElement('div');
      div.className = 'lesson';
      const count = Array.isArray(lesson.words) ? lesson.words.length : 0;
      div.innerHTML = `<h3>${escapeHtml(lesson.title || 'Без названия')}</h3>
        <small>${count} слов</small>`;
      div.onclick = () => openLesson(lesson);
      wrap.appendChild(div);
    });
  }

  // Build meta mapping for a lesson-like object
  function buildMetaForLesson(lesson){
    const meta = [];
    for (let i=0;i<lesson.words.length;i++) meta.push([lesson.id, i]);
    lesson._meta = meta; // attach
    return lesson;
  }

  function openLesson(lesson) {
    const L = buildMetaForLesson({ ...lesson });
    state.currentLesson = L;
    state.idx = 0;
    state.order = [...Array(L.words.length).keys()];
    state.revealed = false;
    $('lesson-title').textContent = L.title;
    $('badge-count').textContent = `${L.words.length} слов`;

    gotoViewer();
    renderCard();
  }

  function playAll(){
    const words = [];
    const meta = [];
    state.lessons.forEach(L => {
      (L.words||[]).forEach((pair, i) => { words.push(pair); meta.push([L.id, i]); });
    });
    const all = { id: 'all', title: 'Все слова', words };
    all._meta = meta;
    state.currentLesson = all;
    state.idx = 0; state.order = [...Array(words.length).keys()]; state.revealed = false;
    $('lesson-title').textContent = all.title;
    $('badge-count').textContent = `${words.length} слов`;
    gotoViewer();
    renderCard();
  }

  function playHard(){
    const words = [];
    const meta = [];
    state.lessons.forEach(L => {
      (L.words||[]).forEach((pair, i) => {
        const k = keyOf(L.id, i);
        if (hardSet.has(k)) { words.push(pair); meta.push([L.id, i]); }
      });
    });
    const hard = { id: 'hard', title: 'HARD-слова', words };
    hard._meta = meta;
    state.currentLesson = hard;
    state.idx = 0; state.order = [...Array(words.length).keys()]; state.revealed = false;
    $('lesson-title').textContent = hard.title;
    $('badge-count').textContent = `${words.length} слов`;
    gotoViewer();
    renderCard();
  }

  function backToLessons(){
    state.currentLesson = null;
    gotoLessons();
  }

  // ===== Card rendering & actions =====
  function currentIndex(){
    const L = state.currentLesson; if (!L) return -1;
    return clamp(state.idx, 0, L.words.length - 1);
  }
  function indexToKey(idx){
    const L = state.currentLesson; if (!L || !L._meta) return null;
    const realIdx = state.order[idx];
    const [lessonId, wordIdx] = L._meta[realIdx];
    return keyOf(lessonId, wordIdx);
  }
  function keyOf(lessonId, wordIdx){ return `${state.bookId}|${lessonId}:${wordIdx}`; }


  function renderCard(){
    const L = state.currentLesson;
    if (!L || !L.words || L.words.length === 0) {
      $('word-front').textContent = 'Нет слов';
      $('word-back').textContent = '—';
      show($('word-back'), false);
      $('counter').textContent = '0 / 0';
      show($('badge-hard'), false);
      return;
    }
    const i = currentIndex();
    state.idx = i;
    const pair = L.words[state.order[i]] || ['—','—'];
    const [en, ru] = Array.isArray(pair) ? pair : ['—','—'];

    const front = state.dir === 'en-ru' ? en : ru;
    const back  = state.dir === 'en-ru' ? ru : en;

    $('word-front').textContent = front;
    $('word-back').textContent  = back;
    show($('word-back'), state.revealed);

    $('counter').textContent = `${i+1} / ${L.words.length}`;

    const k = indexToKey(i);
    const isHard = k && hardSet.has(k);
    $('badge-hard').classList.toggle('hide', !isHard);
    $('toggle-hard').textContent = isHard ? '★ Удалить Hard' : '☆ В Hard';

    $('badge-dir').textContent = state.dir === 'en-ru' ? 'EN→RU' : 'RU→EN';

    // Обновить доступность кнопок
    $('reveal').disabled = state.revealed;
  }

  function next(){
    const L = state.currentLesson; if (!L || !L.words.length) return;
    state.idx = (state.idx + 1) % L.words.length;
    state.revealed = false;
    renderCard();
  }
  function prev(){
    const L = state.currentLesson; if (!L || !L.words.length) return;
    state.idx = (state.idx - 1 + L.words.length) % L.words.length;
    state.revealed = false;
    renderCard();
  }
  function shuffle(){
    const L = state.currentLesson; if (!L) return;
    const arr = state.order;
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    state.idx = 0; state.revealed = false;
    renderCard();
  }
  function reveal(){ state.revealed = true; renderCard(); }
  function toggleDir(){ state.dir = (state.dir === 'en-ru') ? 'ru-en' : 'en-ru'; state.revealed = false; renderCard(); }
  function toggleHard(){
    const i = currentIndex(); if (i < 0) return;
    const k = indexToKey(i); if (!k) return;
    if (hardSet.has(k)) hardSet.delete(k); else hardSet.add(k);
    saveHardSet(hardSet);
    renderCard();
    updateMenuHardButton();
  }

  function updateMenuHardButton(){
    const btn = $('menu-play-hard');
    const count = hardSet.size;
    btn.textContent = count ? `Учить HARD-слова (${count})` : 'Учить HARD-слова (0)';
    btn.disabled = !count;
  }

  // ===== Events =====
  $('book-select').addEventListener('change', async (e) => {
  try {
    const newBookId = String(e.target.value);
    state.bookId = newBookId;

    const { lessons } = await loadLessonsByBookId(newBookId);
    state.lessons = lessons;
    renderLessons();
    gotoMenu();
    updateMenuHardButton();
  } catch (err) {
    console.error('Не удалось загрузить выбранную книгу:', err);
    $('lessons').innerHTML = '<div class="muted">Не удалось загрузить выбранную книгу.</div>';
    gotoMenu();
   }
  });

  $('btn-menu').addEventListener('click', gotoMenu);
  $('btn-home').addEventListener('click', backToLessons);

  $('next').addEventListener('click', next);
  $('prev').addEventListener('click', prev);
  $('shuffle').addEventListener('click', shuffle);
  $('reveal').addEventListener('click', reveal);
  $('badge-dir').addEventListener('click', toggleDir); 
  $('toggle-hard').addEventListener('click', toggleHard);

  $('menu-choose-lesson').addEventListener('click', gotoLessons);
  $('menu-play-all').addEventListener('click', playAll);
  $('menu-play-hard').addEventListener('click', playHard);
  $('menu-about').addEventListener('click', () => alert(`Vocab Trainer PWA
Режим самопроверки: нажмите «Показать перевод».
Отмечайте сложные слова кнопкой «В Hard».`));

  // Клавиатура (для десктопа)
  window.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight' || e.key === 'Enter') next();
    else if (e.key === 'ArrowLeft') prev();
    else if (e.code === 'Space') { e.preventDefault(); if (!state.revealed) reveal(); }
    else if (e.key && e.key.toLowerCase && e.key.toLowerCase() === 'h') toggleHard();
    else if (e.key && e.key.toLowerCase && e.key.toLowerCase() === 'd') toggleDir();
  });

  // Жесты (мобильный приоритет): свайпы и долгий тап
  (function initGestures(){
    const zone = document.getElementById('touch-area');
    let sx=0, sy=0, ex=0, ey=0, t0=0, longTapTimer=null, moved=false;
    const THRESH = 40; // пикселей для свайпа
    const LONG_MS = 500; // долгий тап для Hard

    zone.addEventListener('touchstart', (e) => {
      const t = e.changedTouches[0];
      sx = ex = t.clientX; sy = ey = t.clientY; t0 = Date.now(); moved=false;
      clearTimeout(longTapTimer);
      longTapTimer = setTimeout(() => { toggleHard(); }, LONG_MS);
    }, {passive:true});

    zone.addEventListener('touchmove', (e) => {
      const t = e.changedTouches[0]; ex = t.clientX; ey = t.clientY;
      if (Math.hypot(ex-sx, ey-sy) > 8) moved=true;
      if (moved) clearTimeout(longTapTimer);
    }, {passive:true});

    zone.addEventListener('touchend', (e) => {
      clearTimeout(longTapTimer);
      const dx = ex - sx; const dy = ey - sy;
      if (Math.abs(dx) < THRESH && Math.abs(dy) < THRESH) {
        if (!state.revealed) reveal(); else next();
        return;
      }
      if (Math.abs(dx) > Math.abs(dy)) {
        if (dx < -THRESH) next();
        else if (dx > THRESH) prev();
      } else {
        if (dy < -THRESH) reveal();
        else if (dy > THRESH) toggleDir();
      }
    }, {passive:true});
  })();

  // ===== Boot =====
  // ===== Boot =====
  (async () => {
    try {
      const books = await loadBooks();
      // если ранее сохранённая книга не задана — берём первую
      state.bookId = books[0] ? String(books[0].id) : '1';
      populateBookSelect(books);
  
      const { lessons } = await loadLessonsByBookId(state.bookId);
      state.lessons = lessons;
  
      renderLessons();
      gotoMenu();
      updateMenuHardButton();
      runSelfTests();
    } catch (e) {
      console.error('Не удалось загрузить книги/уроки:', e);
      $('lessons').innerHTML = '<div class="muted">words.json недоступен или имеет неверную структуру.</div>';
      gotoMenu();
      runSelfTests(true);
    }
  })();


  // ===== Self-tests =====
  function runSelfTests(errorMode=false){
    const results = [];
    const assert = (name, cond) => { results.push({ name, cond }); };

    // Наличие мобильных элементов и поведения
    assert('Есть touch-area', !!document.getElementById('touch-area'));
    assert('Кнопка Показать перевод существует', !!$('reveal'));
    assert('Переключатель EN↔RU (badge-dir) существует', !!$('badge-dir'));
    assert('Кнопка В Hard существует', !!$('toggle-hard'));

    // Данные
    assert('hardSet инициализирован', hardSet instanceof Set);

    if (Array.isArray(state.lessons) && state.lessons.length) {
      const L0 = state.lessons[0];
      assert('lesson[0].words — массив', Array.isArray(L0.words));
      if (L0.words.length) {
        const pair = L0.words[0];
        assert('слово — пара из 2', Array.isArray(pair) && pair.length === 2);
      }
    }

    // Логика перевода
    const dir0 = state.dir; toggleDir(); const dir1 = state.dir; toggleDir();
    assert('toggleDir меняет направление', dir0 !== dir1);

    const ok = results.filter(r=>r.cond).length; const fail = results.length - ok;
    console.group('%cSelf-tests (mobile-first)', 'color:#22d3ee');
    results.forEach(r => console.log(r.cond ? '✅' : '❌', r.name));
    console.log(`Итог: ${ok}/${results.length} пройдено${fail?`, ${fail} ошибок`:''}.`, errorMode?'(errorMode)':'');
    console.groupEnd();
  }

  // ===== SW registration (optional) =====
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(console.warn);
  }
  </script></body>
</html>